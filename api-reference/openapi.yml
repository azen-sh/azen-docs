openapi: 3.0.3

info:
  title: Azen API
  version: v1
  description: >
    Azen Memory API for storing, retrieving, and searching user memories.

servers:
  - url: https://api.azen.sh/api/v1
    description: Production API

security:
  - AzenApiKey: []

components:
  securitySchemes:
    AzenApiKey:
      type: apiKey
      in: header
      name: azen-api-key

  schemas:
    Memory:
      type: object
      properties:
        id:
          type: string
          format: uuid
        content:
          type: string
        metadata:
          type: object
          nullable: true
        createdAt:
          type: string
          format: date-time
        embedded:
          type: boolean

    CreateMemoryRequest:
      type: object
      required:
        - text
      properties:
        text:
          type: string
          example: "User likes cold brew coffee"
        dedupKey:
          type: string
          nullable: true
          example: "preference:coffee"

    CreateMemoryResponse:
      type: object
      properties:
        status:
          type: string
          example: success
        memoryId:
          type: string
          format: uuid
        createdAt:
          type: string
          format: date-time
        embeddingStatus:
          type: string
          example: processing

    SearchRequest:
      type: object
      required:
        - query
      properties:
        query:
          type: string
          example: "What drinks does the user like?"
        topK:
          type: integer
          minimum: 1
          maximum: 50
          default: 5

    ErrorResponse:
      type: object
      properties:
        status:
          type: string
          example: error
        message:
          type: string
          example: Error message
        code:
          type: integer
          example: 400
        details:
          type: object
          nullable: true

paths:
  /memory:
    post:
      summary: Create a new memory
      description: >
        Stores a memory for the authenticated user and queues it for embedding.
        If a `dedupKey` is provided and matches an existing memory,
        the existing one is returned instead.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateMemoryRequest"
            examples:
              default:
                summary: Create memory
                value:
                  text: "User likes cold brew coffee"
                  dedupKey: "preference:coffee"
      responses:
        "201":
          description: Memory accepted and queued
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CreateMemoryResponse"
              example:
                status: success
                memoryId: "a1ed9d9e-44b3-4e7b-bc47-084c65a3e921"
                createdAt: "2025-01-01T12:10:33.000Z"
                embeddingStatus: processing
        "200":
          description: Memory already exists (deduplication)
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: success
                  memoryId:
                    type: string
                    format: uuid
                  duplicated:
                    type: boolean
                  message:
                    type: string
              example:
                status: success
                memoryId: "a1ed9d9e-44b3-4e7b-bc47-084c65a3e921"
                duplicated: true
                message: "Memory already exists with this dedupKey"
        "400":
          description: Invalid JSON or invalid request body
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Missing API key
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Invalid API key
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "429":
          description: Rate limit exceeded
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

    get:
      summary: List user memories
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: per
          in: query
          schema:
            type: integer
            default: 20
            maximum: 100
      responses:
        "200":
          description: Paginated list of memories
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: success
                  memories:
                    type: array
                    items:
                      $ref: "#/components/schemas/Memory"
                  page:
                    type: integer
                  per:
                    type: integer
        "401":
          description: Missing API key
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Invalid API key
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "429":
          description: Rate limit exceeded
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /memory/{id}:
    get:
      summary: Retrieve a memory by ID
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Memory record or null
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: success
                  memory:
                    allOf:
                      - $ref: "#/components/schemas/Memory"
                    nullable: true
                  message:
                    type: string
        "400":
          description: Invalid memory ID
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Missing API key
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Invalid API key
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "429":
          description: Rate limit exceeded
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

    delete:
      summary: Delete a memory
      description: >
        Deletes the memory record and its vector embedding.
        Returns deleted=false if memory does not exist.
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Deletion result
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: success
                  deleted:
                    type: boolean
                  memoryId:
                    type: string
                  message:
                    type: string
        "400":
          description: Invalid memory ID
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Missing API key
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Invalid API key
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "429":
          description: Rate limit exceeded
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /memory/search:
    post:
      summary: Search user memories
      description: >
        Performs semantic search on user memories using vector embeddings.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SearchRequest"
            examples:
              default:
                summary: Semantic search
                value:
                  query: "What drinks does the user like?"
                  topK: 5
      responses:
        "200":
          description: Ranked memory results
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: success
                  memories:
                    type: array
                    items:
                      $ref: "#/components/schemas/Memory"
                  rawMatches:
                    type: array
                    items:
                      type: object
        "400":
          description: Invalid request body
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Missing API key
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Invalid API key
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "429":
          description: Rate limit exceeded
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
